<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ðŸŽ§ CENTRAL DE RECEPCIÃ“N HD</title>
    <style>
        body { background:#0a0a0a; color:#00ff00; font-family:monospace; padding:40px; text-align:center; }
        .monitor { background:#111; border:2px solid #00ff00; border-radius:15px; padding:30px; display:inline-block; }
        .vu-meter { width:300px; height:20px; background:#222; margin:10px 0; border:1px solid #444; position:relative; }
        .bar { height:100%; width:0%; background:linear-gradient(90deg, #00ff00, #ffff00, #ff0000); transition:0.05s; }
        #id-display { font-size:24px; background:#000; padding:10px; margin:20px 0; border:1px dashed #00ff00; }
    </style>
</head>
<body>
    <div class="monitor">
        <h2>ðŸ“» CENTRAL DE RADIO</h2>
        <div id="id-display">GENERANDO ID...</div>
        <p>Pega este ID en el celular emisor</p>
        
        <div style="text-align:left; margin-top:20px;">
            <label>L</label>
            <div class="vu-meter"><div id="bar-L" class="bar"></div></div>
            <label>R</label>
            <div class="vu-meter"><div id="bar-R" class="bar"></div></div>
        </div>
        <div id="info">Esperando seÃ±al...</div>
    </div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const iceConfig = {
        config: {
            iceServers: [
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", password: "openrelayproject" }
            ]
        }
    };

    const peer = new Peer("CENTRAL-BROADCAST-TEST", iceConfig); // Puedes cambiar este ID a uno fijo

    peer.on('open', id => document.getElementById('id-display').innerText = id);

    peer.on('call', call => {
        call.answer();
        document.getElementById('info').innerText = "ðŸŸ¢ EN VIVO - RECIBIENDO AUDIO";
        
        call.on('stream', remoteStream => {
            const audio = new Audio();
            audio.srcObject = remoteStream;
            audio.play();

            // AnÃ¡lisis EstÃ©reo
            const ctx = new AudioContext();
            const src = ctx.createMediaStreamSource(remoteStream);
            const splitter = ctx.createChannelSplitter(2);
            const ansL = ctx.createAnalyser();
            const ansR = ctx.createAnalyser();
            
            src.connect(splitter);
            splitter.connect(ansL, 0);
            splitter.connect(ansR, 1);

            const dataL = new Uint8Array(ansL.frequencyBinCount);
            const dataR = new Uint8Array(ansR.frequencyBinCount);

            const draw = () => {
                ansL.getByteFrequencyData(dataL);
                ansR.getByteFrequencyData(dataR);
                let vL = dataL.reduce((a,b)=>a+b,0)/dataL.length;
                let vR = dataR.reduce((a,b)=>a+b,0)/dataR.length;
                document.getElementById('bar-L').style.width = (vL*2.5)+"%";
                document.getElementById('bar-R').style.width = (vR*2.5)+"%";
                requestAnimationFrame(draw);
            };
            draw();
        });
    });
</script>
</body>
</html>