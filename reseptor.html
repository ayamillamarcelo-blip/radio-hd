<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Receptor HD Pro - Monitor & Grabaci√≥n</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #0d1117; 
            color: #c9d1d9; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0;
        }
        .card { 
            background: #161b22; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.7); 
            text-align: center; 
            width: 100%; 
            max-width: 420px; 
            border: 1px solid #30363d;
        }
        .status-container { margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        #peer-id { 
            font-family: 'Courier New', monospace; 
            color: #39ff14; 
            background: #010409;
            padding: 10px;
            border-radius: 5px;
            display: block;
            margin: 10px 0;
            border: 1px solid #30363d;
        }

        /* --- VUMETRO ESTEREO --- */
        .vu-container { display: flex; flex-direction: column; gap: 8px; margin: 20px 0; }
        .vu-row { display: flex; align-items: center; gap: 10px; }
        .vu-label { font-size: 10px; color: #8b949e; width: 15px; }
        .vu-bg { flex-grow: 1; height: 14px; background: #000; border-radius: 3px; overflow: hidden; border: 1px solid #333; }
        .vu-bar { width: 0%; height: 100%; background: #4CAF50; transition: width 0.05s ease-out; }

        .led { width: 12px; height: 12px; background: #333; border-radius: 50%; }
        .led-on { background: #ff3e3e; box-shadow: 0 0 10px #ff3e3e; }

        button {
            width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none;
            font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.3s;
        }
        .btn-record { background: #444; color: white; }
        .btn-record.recording { background: #f44336; animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <div class="card">
        <div class="status-container">
            <div id="led-indicator" class="led"></div>
            <span id="txt-status">ESPERANDO SE√ëAL HD...</span>
        </div>
        
        <span id="peer-id">Generando ID...</span>

        <div class="vu-container">
            <div class="vu-row">
                <span class="vu-label">L</span>
                <div class="vu-bg"><div id="vu-L" class="vu-bar"></div></div>
            </div>
            <div class="vu-row">
                <span class="vu-label">R</span>
                <div class="vu-bg"><div id="vu-R" class="vu-bar"></div></div>
            </div>
        </div>

        <button id="btn-grab" class="btn-record" onclick="toggleRecording()">‚è∫ Iniciar Grabaci√≥n</button>
        
        <audio id="remote-audio" autoplay></audio>
        <p style="font-size: 0.7em; color: #484f58; margin-top: 15px;">Haz clic en cualquier lugar para habilitar audio si no escuchas nada.</p>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        const peer = new Peer();
        const audioRemote = document.getElementById('remote-audio');
        const statusTxt = document.getElementById('txt-status');
        const led = document.getElementById('led-indicator');
        const btnGrab = document.getElementById('btn-grab');
        
        let mediaRecorder;
        let recordedChunks = [];
        let streamActivo;

        peer.on('open', id => { document.getElementById('peer-id').innerText = id; });

        peer.on('call', call => {
            const opcionesRespuesta = {
                sdpTransform: (sdp) => {
                    return sdp.replace('useinbandfec=1', 'useinbandfec=1; stereo=1; maxaveragebitrate=256000; sprop-stereo=1');
                }
            };

            call.answer(null, opcionesRespuesta); 
            
            call.on('stream', remoteStream => {
                streamActivo = remoteStream;
                audioRemote.srcObject = remoteStream;
                
                statusTxt.innerText = "¬°EN EL AIRE!";
                statusTxt.style.color = "#ff3e3e";
                led.classList.add('led-on');

                activarVumetroEstereo(remoteStream);
            });
        });

        function activarVumetroEstereo(stream) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
            const source = audioCtx.createMediaStreamSource(stream);
            const splitter = audioCtx.createChannelSplitter(2);
            source.connect(splitter);

            const analyserL = audioCtx.createAnalyser();
            const analyserR = audioCtx.createAnalyser();
            analyserL.fftSize = analyserR.fftSize = 256;

            splitter.connect(analyserL, 0); 
            splitter.connect(analyserR, 1); 

            const dataL = new Uint8Array(analyserL.frequencyBinCount);
            const dataR = new Uint8Array(analyserR.frequencyBinCount);

            function draw() {
                if (statusTxt.innerText !== "¬°EN EL AIRE!") return;
                
                analyserL.getByteFrequencyData(dataL);
                analyserR.getByteFrequencyData(dataR);

                const calcularVol = (data) => {
                    let sum = 0;
                    for(let i=0; i<data.length; i++) sum += data[i];
                    return Math.min((sum / data.length) * 2, 100);
                };

                actualizarBarra('vu-L', calcularVol(dataL));
                actualizarBarra('vu-R', calcularVol(dataR));
                
                requestAnimationFrame(draw);
            }

            function actualizarBarra(id, vol) {
                const bar = document.getElementById(id);
                bar.style.width = vol + "%";
                if (vol < 75) bar.style.background = "#4CAF50";
                else if (vol < 90) bar.style.background = "#ffeb3b";
                else bar.style.background = "#f44336";
            }
            draw();
        }

        function toggleRecording() {
            if (!streamActivo) return alert("Espera a recibir se√±al para grabar.");

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                btnGrab.innerText = "‚è∫ Iniciar Grabaci√≥n";
                btnGrab.classList.remove('recording');
            } else {
                recordedChunks = [];
                // Graba en alta calidad
                mediaRecorder = new MediaRecorder(streamActivo, { mimeType: 'audio/webm;codecs=opus' });
                
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `grabacion-hd-${Date.now()}.webm`;
                    a.click();
                };

                mediaRecorder.start();
                btnGrab.innerText = "üõë Detener Grabaci√≥n";
                btnGrab.classList.add('recording');
            }
        }
    </script>
</body>
</html>
