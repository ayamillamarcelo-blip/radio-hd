<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Receptor HD - VÃºmetro Lateral</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #0e0e0e;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
    }

    .card {
        background: #1b1b1b;
        padding: 25px;
        border-radius: 15px;
        width: 100%;
        max-width: 450px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        border: 1px solid #333;
    }

    h2 { color: #4CAF50; margin-bottom: 20px; font-size: 1.2rem; }

    /* CONTENEDOR VÃšMETRO LATERAL */
    .vu-lateral-container {
        background: #000;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #222;
    }

    .vu-row {
        display: flex;
        align-items: center;
        margin: 10px 0;
    }

    .vu-label {
        width: 30px;
        font-size: 12px;
        font-weight: bold;
        color: #888;
        text-align: left;
    }

    .vu-track {
        flex-grow: 1;
        height: 12px;
        background: #1a1a1a;
        border-radius: 6px;
        overflow: hidden;
        margin-left: 10px;
        position: relative;
    }

    .vu-fill {
        height: 100%;
        width: 0%; /* Controlado por JS */
        background: linear-gradient(to right, #4CAF50 50%, #FFEB3B 80%, #F44336 100%);
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        transition: width 0.05s ease-out;
    }

    .id-box {
        background: #000;
        padding: 10px;
        border-radius: 6px;
        font-family: monospace;
        color: #00ff00;
        font-size: 12px;
        margin-bottom: 15px;
    }

    .onair { color: #f44336; font-weight: bold; display: none; margin-top: 10px; }
</style>
</head>

<body>

<div class="card">
    <h2>Receptor Stereo HD</h2>

    <div class="id-box" id="mi-id">Conectando...</div>

    <div class="vu-lateral-container">
        <div class="vu-row">
            <span class="vu-label">L</span>
            <div class="vu-track"><div id="bar-L" class="vu-fill"></div></div>
        </div>
        <div class="vu-row">
            <span class="vu-label">R</span>
            <div class="vu-track"><div id="bar-R" class="vu-fill"></div></div>
        </div>
    </div>

    <div id="estado" style="font-size: 13px; color: #aaa;">ðŸ•“ Esperando seÃ±alâ€¦</div>
    <audio id="audio" autoplay playsinline></audio>
    <div id="onair" class="onair">ðŸ”´ AL AIRE</div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const peer = new Peer({
  config: {
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" }
    ]
  }
});

const miId = document.getElementById("mi-id");
const barL = document.getElementById("bar-L");
const barR = document.getElementById("bar-R");
const audio = document.getElementById("audio");
const estado = document.getElementById("estado");
const onair = document.getElementById("onair");

let audioCtx, analyserL, analyserR;

function iniciarAudioVisual(stream) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    const splitter = audioCtx.createChannelSplitter(2);
    
    analyserL = audioCtx.createAnalyser();
    analyserR = audioCtx.createAnalyser();
    
    source.connect(splitter);
    splitter.connect(analyserL, 0);
    splitter.connect(analyserR, 1);

    const dataL = new Uint8Array(analyserL.frequencyBinCount);
    const dataR = new Uint8Array(analyserR.frequencyBinCount);

    function loop() {
        analyserL.getByteFrequencyData(dataL);
        analyserR.getByteFrequencyData(dataR);

        // Promedio de volumen
        let vL = dataL.reduce((a, b) => a + b) / dataL.length;
        let vR = dataR.reduce((a, b) => a + b) / dataR.length;

        // Ajustar el factor (1.8) para mayor o menor sensibilidad
        barL.style.width = Math.min(vL * 1.8, 100) + "%";
        barR.style.width = Math.min(vR * 1.8, 100) + "%";

        requestAnimationFrame(loop);
    }
    loop();
}

peer.on("open", id => { miId.textContent = id; });

peer.on("call", call => {
    call.answer();
    call.on("stream", stream => {
        audio.srcObject = stream;
        audio.play();
        estado.textContent = "ðŸŽ§ SeÃ±al Activa";
        onair.style.display = "block";
        if (!audioCtx) iniciarAudioVisual(stream);
    });
});
</script>

</body>
</html>
