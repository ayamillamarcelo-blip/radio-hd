<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ðŸŽ§ RECEPTOR STEREO HD</title>
    <style>
        body { background: #050505; color: #00ff00; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .monitor { background: #111; border: 2px solid #333; border-radius: 15px; padding: 25px; width: 420px; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .id-box { font-size: 24px; background: #000; padding: 15px; margin: 15px 0; border: 1px solid #00ff00; color: #fff; border-radius: 8px; min-height: 30px; }
        .vu-container { height: 15px; background: #000; border-radius: 10px; margin: 5px 0 15px 0; overflow: hidden; border: 1px solid #222; }
        .vu-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000); transition: width 0.05s; }
        button { background: #00ff00; color: #000; border: none; padding: 15px; font-weight: bold; cursor: pointer; width: 100%; border-radius: 5px; font-size: 14px; }
        #status { color: #888; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="monitor">
        <h2 style="color: #fff; margin: 0 0 10px 0;">ðŸ“» CENTRAL HD</h2>
        
        <div class="id-box" id="mi-id">CONECTANDO...</div>
        <div id="status">Iniciando conexiÃ³n...</div>

        <div style="text-align: left; font-size: 10px; margin-top: 15px; color: #666;">L - CANAL IZQUIERDO</div>
        <div class="vu-container"><div id="vu-l" class="vu-bar"></div></div>
        
        <div style="text-align: left; font-size: 10px; color: #666;">R - CANAL DERECHO</div>
        <div class="vu-container"><div id="vu-r" class="vu-bar"></div></div>

        <button onclick="activarYReconectar()">ðŸ”“ ACTIVAR Y FORZAR ID</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <script>
        let peer;
        let audioCtx;

        function crearPeer() {
            // Intentamos conectar con una configuraciÃ³n mÃ¡s robusta
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 3
            });

            peer.on('open', (id) => {
                document.getElementById('mi-id').innerText = id;
                document.getElementById('status').innerText = "ðŸŸ¢ LISTO: PegÃ¡ este ID en el celular";
            });

            peer.on('call', (call) => {
                document.getElementById('status').innerText = "ðŸ“¡ RECIBIENDO AUDIO...";
                call.answer(); 
                
                call.on('stream', (stream) => {
                    const audio = new Audio();
                    audio.srcObject = stream;
                    audio.play();
                    iniciarVumetro(stream);
                });
            });

            peer.on('error', (err) => {
                console.error(err);
                document.getElementById('mi-id').innerText = "REINTENTANDO...";
                document.getElementById('status').innerText = "âŒ Error: " + err.type;
                // Si falla, reintenta en 3 segundos
                setTimeout(crearPeer, 3000);
            });
        }

        function iniciarVumetro(stream) {
            if (!audioCtx) audioCtx = new AudioContext();
            const source = audioCtx.createMediaStreamSource(stream);
            const splitter = audioCtx.createChannelSplitter(2);
            const anaL = audioCtx.createAnalyser();
            const anaR = audioCtx.createAnalyser();

            source.connect(splitter);
            splitter.connect(anaL, 0);
            splitter.connect(anaR, 1);

            const dataL = new Uint8Array(anaL.frequencyBinCount);
            const dataR = new Uint8Array(anaR.frequencyBinCount);

            function update() {
                anaL.getByteFrequencyData(dataL);
                anaR.getByteFrequencyData(dataR);
                let vL = dataL.reduce((a, b) => a + b, 0) / dataL.length;
                let vR = dataR.reduce((a, b) => a + b, 0) / dataR.length;
                document.getElementById('vu-l').style.width = (vL * 2.5) + "%";
                document.getElementById('vu-r').style.width = (vR * 2.5) + "%";
                requestAnimationFrame(update);
            }
            update();
        }

        function activarYReconectar() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (peer) peer.destroy();
            crearPeer();
        }

        // Iniciar al cargar
        crearPeer();
    </script>
</body>
</html>


